{"launcher": "slurm", "train_batch_size": 320, "train_micro_batch_size_per_gpu": 1, "gradient_accumulation_steps": 64, "optimizer": {"type": "Adam", "params": {"lr": 1.5e-05, "betas": [0.9, 0.95], "eps": 1e-08}}, "fp32_allreduce": true, "fp16": {"enabled": false, "type": "bfloat16", "loss_scale": 0, "loss_scale_window": 1000, "hysteresis": 2, "min_loss_scale": 1}, "gradient_clipping": 0.4, "zero_optimization": {"stage": 1, "allgather_partitions": true, "allgather_bucket_size": 500000000, "overlap_comm": true, "reduce_scatter": true, "reduce_bucket_size": 500000000, "contiguous_gradients": true}, "steps_per_print": 1, "bf16": {"enabled": true}, "data_types": {"grad_accum_dtype": "fp32"}, "precision": "bfloat16", "num_layers": 80, "hidden_size": 8192, "num_attention_heads": 64, "num_attention_heads_kv": 8, "seq_length": 4096, "max_position_embeddings": 4096, "norm": "apexrmsnorm", "rms_norm_epsilon": 1e-05, "pos_emb": "rotary", "no_weight_tying": true, "attention_config": ["flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash", "flash"], "sparsity_config": {}, "make_vocab_size_divisible_by": 1, "activation": "silu", "scaled_upper_triang_masked_softmax_fusion": true, "use_bias_in_norms": false, "multi_query": true, "use_bias_in_attn_linear": false, "mlp_type": "llama", "ffn_dim_multiplier": 1.3, "llama_mlp_multiple_of": 4096, "init_method": "small_init", "output_layer_init_method": "wang_init", "output_layer_parallelism": "column", "lr_decay_style": "cosine", "lr_decay_iters": 58831, "min_lr": 8e-06, "warmup": 0.05, "optimizer_type": "Adam", "zero_stage": 1, "zero_reduce_scatter": true, "zero_contiguous_gradients": true, "zero_reduce_bucket_size": 500000000, "zero_allgather_bucket_size": 500000000, "lr": 1.5e-05, "tokenizer_type": "HFLlamaTokenizer", "megatron_config_path": "/platform_tech/jyren/pretrainpipeline/ren-workspace/0926/config_megatron/megatron_config.json", "train_data_paths": ["/shared_space/agpt/experiments/0808/data/authors_text_tail_document", "/shared_space/agpt/experiments/0808/data/cc_en_text_document", "/shared_space/agpt/experiments/0808/data/cc_en_text_tail_document", "/shared_space/agpt/experiments/0808/data/cn_data_text_document", "/shared_space/agpt/experiments/0808/data/cn_data_text_tail_document", "/shared_space/agpt/experiments/0808/data/latex_text_document", "/shared_space/agpt/experiments/0808/data/latex_text_tail_document", "/shared_space/agpt/experiments/0808/data/pdf_bio_text_document", "/shared_space/agpt/experiments/0808/data/pdf_bio_text_tail_document", "/shared_space/agpt/experiments/0808/data/pdf_cs_text_document", "/shared_space/agpt/experiments/0808/data/pdf_cs_text_tail_document", "/shared_space/agpt/experiments/0808/data/pdf_med_text_document", "/shared_space/agpt/experiments/0808/data/pdf_med_text_tail_document", "/shared_space/agpt/experiments/0808/data/prof_li_text_document", "/shared_space/agpt/experiments/0808/data/prof_li_text_tail_document", "/shared_space/agpt/experiments/0808/data/prof_luo_text_document", "/shared_space/agpt/experiments/0808/data/prof_luo_text_tail_document", "/shared_space/agpt/experiments/0808/data/s2_text_document", "/shared_space/agpt/experiments/0808/data/s2_text_tail_document"], "test_data_paths": ["/shared_space/agpt/experiments/0712/data/academic_cs_pdf_author_0714_val_text_document"], "valid_data_paths": ["/shared_space/agpt/experiments/0712/data/academic_cs_pdf_author_0714_val_text_document"], "valid_data_names": ["0"], "valid_by_datasets": true, "train_indexmap_data_paths": ["/shared_space/agpt/experiments/0926/data/indexmap/authors_text_tail_document", "/shared_space/agpt/experiments/0926/data/indexmap/cc_en_text_document", "/shared_space/agpt/experiments/0926/data/indexmap/cc_en_text_tail_document", "/shared_space/agpt/experiments/0926/data/indexmap/cn_data_text_document", "/shared_space/agpt/experiments/0926/data/indexmap/cn_data_text_tail_document", "/shared_space/agpt/experiments/0926/data/indexmap/latex_text_document", "/shared_space/agpt/experiments/0926/data/indexmap/latex_text_tail_document", "/shared_space/agpt/experiments/0926/data/indexmap/pdf_bio_text_document", "/shared_space/agpt/experiments/0926/data/indexmap/pdf_bio_text_tail_document", "/shared_space/agpt/experiments/0926/data/indexmap/pdf_cs_text_document", "/shared_space/agpt/experiments/0926/data/indexmap/pdf_cs_text_tail_document", "/shared_space/agpt/experiments/0926/data/indexmap/pdf_med_text_document", "/shared_space/agpt/experiments/0926/data/indexmap/pdf_med_text_tail_document", "/shared_space/agpt/experiments/0926/data/indexmap/prof_li_text_document", "/shared_space/agpt/experiments/0926/data/indexmap/prof_li_text_tail_document", "/shared_space/agpt/experiments/0926/data/indexmap/prof_luo_text_document", "/shared_space/agpt/experiments/0926/data/indexmap/prof_luo_text_tail_document", "/shared_space/agpt/experiments/0926/data/indexmap/s2_text_document", "/shared_space/agpt/experiments/0926/data/indexmap/s2_text_tail_document"], "test_indexmap_data_paths": ["/shared_space/agpt/experiments/0712/data/indexmap/test_text_document"], "valid_indexmap_data_paths": ["/shared_space/agpt/experiments/0712/data/indexmap/val_text_document"], "train_data_weights": [21118556, 1890426880, 5261477599, 4016177152, 8746544665, 5897609216, 877329485, 4357517312, 835848124, 12765122560, 3643188406, 4720377856, 1731667591, 50024448, 6575748, 119255040, 25544187, 88899584, 22055187644], "valid_data_weights": [1.0], "test_data_weights": [1.0], "data_impl": "mmap", "save": "/shared_space/agpt/experiments/0926/checkpoints", "config_files": {"70b.yml": "{\n  \"vocab-file\": \"/shared_space/agpt/models/llama2/hf/70B\",\n  \"save\": \"/shared_space/agpt/experiments/0926/checkpoints\",\n  \"load\": \"/shared_space/agpt/experiments/0808/checkpoints\", # no extra tokens\n  \"megatron_config_path\": \"/platform_tech/jyren/pretrainpipeline/ren-workspace/0926/config_megatron/megatron_config.json\",\n\n  \"train-data-paths\": [\n    \"/shared_space/agpt/experiments/0808/data/authors_text_tail_document\",\n    \"/shared_space/agpt/experiments/0808/data/cc_en_text_document\",\n    \"/shared_space/agpt/experiments/0808/data/cc_en_text_tail_document\",\n    \"/shared_space/agpt/experiments/0808/data/cn_data_text_document\",\n    \"/shared_space/agpt/experiments/0808/data/cn_data_text_tail_document\",\n    \"/shared_space/agpt/experiments/0808/data/latex_text_document\",\n    \"/shared_space/agpt/experiments/0808/data/latex_text_tail_document\",\n    \"/shared_space/agpt/experiments/0808/data/pdf_bio_text_document\",\n    \"/shared_space/agpt/experiments/0808/data/pdf_bio_text_tail_document\",\n    \"/shared_space/agpt/experiments/0808/data/pdf_cs_text_document\",\n    \"/shared_space/agpt/experiments/0808/data/pdf_cs_text_tail_document\",\n    \"/shared_space/agpt/experiments/0808/data/pdf_med_text_document\",\n    \"/shared_space/agpt/experiments/0808/data/pdf_med_text_tail_document\",\n    \"/shared_space/agpt/experiments/0808/data/prof_li_text_document\",\n    \"/shared_space/agpt/experiments/0808/data/prof_li_text_tail_document\",\n    \"/shared_space/agpt/experiments/0808/data/prof_luo_text_document\",\n    \"/shared_space/agpt/experiments/0808/data/prof_luo_text_tail_document\",\n    \"/shared_space/agpt/experiments/0808/data/s2_text_document\",\n    \"/shared_space/agpt/experiments/0808/data/s2_text_tail_document\",\n    ],\n  \"test-data-paths\": [\n    \"/shared_space/agpt/experiments/0712/data/academic_cs_pdf_author_0714_val_text_document\",\n    ],\n  \"valid-data-paths\": [\n    \"/shared_space/agpt/experiments/0712/data/academic_cs_pdf_author_0714_val_text_document\",\n    ],\n\n  \"train-data-weights\": [\n      21118556, \n      1890426880,\n      5261477599,\n      4016177152,\n      8746544665,\n      5897609216,\n      877329485,\n      4357517312,\n      835848124,\n      12765122560,\n      3643188406,\n      4720377856,\n      1731667591,\n      50024448,\n      6575748,\n      119255040,\n      25544187,\n      88899584,\n      22055187644,\n    ],  # sum  77109892053\n\n  \"test-data-weights\": [1.],\n  \"valid-data-weights\": [1.],\n  \"valid_by_datasets\": true,\n\n  \"train-indexmap-data-paths\": [\n    \"/shared_space/agpt/experiments/0926/data/indexmap/authors_text_tail_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/cc_en_text_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/cc_en_text_tail_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/cn_data_text_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/cn_data_text_tail_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/latex_text_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/latex_text_tail_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/pdf_bio_text_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/pdf_bio_text_tail_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/pdf_cs_text_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/pdf_cs_text_tail_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/pdf_med_text_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/pdf_med_text_tail_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/prof_li_text_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/prof_li_text_tail_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/prof_luo_text_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/prof_luo_text_tail_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/s2_text_document\",\n    \"/shared_space/agpt/experiments/0926/data/indexmap/s2_text_tail_document\",\n    ],\n  \"test-indexmap-data-paths\": [\n    \"/shared_space/agpt/experiments/0712/data/indexmap/test_text_document\",\n    ],\n  \"valid-indexmap-data-paths\": [\n    \"/shared_space/agpt/experiments/0712/data/indexmap/val_text_document\",\n    ],\n\n  \"use_wandb\": true,\n  \"wandb_project\": \"llama2_70b_pretrain2\",\n  \"wandb_group\": \"70b\",\n  \"wandb_team\": \"academicgpt\",\n  \"launcher\": \"slurm\",\n  \"deepspeed_slurm\": false,\n  \"global_num_gpus\": 160,\n\n  \"multi_query\": true,\n\n  \"load_module_only\": true, # \u91cd\u542f\u4e3afalse\n  \"finetune\": true, # \u91cd\u542f\u4e3afalse, false\u52a0\u8f7doptimizer\n  \"attention_config\": [[[\"flash\"], \"all\"]],\n\n  \"pipe-parallel-size\": 8,\n  \"model-parallel-size\": 4,\n  \"make_vocab_size_divisible_by\": 1, \n\n  # \"dynamic_rotary\": true,  # \u52a8\u6001\u63d2\u503c\u6269\u7a97\u53e3\n  # \"origin-position-embeedings\": 4096, # llama2\n  # \"ntk\": 2,\n\n  \"reset_attention_mask\": false, # \u5982\u679cflash\uff0c\u5219false\uff1b flash_triton\uff0c\u53ef\u4ee5true\n  \"reset_position_ids\": false, # \u5982\u679cflash\uff0c\u5219false\uff1b flash_triton\uff0c\u53ef\u4ee5true\n  \"eod_mask_loss\": false,  # ?? \u5e94\u8be5false?\n\n  \"num-layers\": 80,\n  \"hidden-size\": 8192,\n  \"num-attention-heads\": 64,\n  \n  \"num_attention_heads_kv\": 8, \n  \"llama_mlp_multiple_of\": 4096,\n  \"ffn_dim_multiplier\": 1.3,\n\n  \"seq-length\": 4096,\n  \"max-position-embeddings\": 4096,\n  \n  \"norm\": \"apexrmsnorm\", # \"apexrmsnorm\", \"llamarmsnorm\"\n  \"rms_norm_epsilon\": 1.0e-5,\n  \n  \"pos-emb\": \"rotary\",\n  \"rotary_pct\": 1,\n  \"no-weight-tying\": true,\n  \"gpt_j_residual\": false,\n  \"output_layer_parallelism\": \"column\",\n  \"scaled-upper-triang-masked-softmax-fusion\": True, # use fused ops of [scale, upper triang mask, softmax]\n  \"bias-gelu-fusion\": false,\n  \"use_bias_in_norms\": false,\n  \"use_bias_in_attn_linear\": false,\n  \"mlp_type\": \"llama\",\n  \"activation\": \"silu\",\n  \"init_method\": \"small_init\",\n  \"output_layer_init_method\": \"wang_init\",\n\n  \"optimizer\": {\n    \"type\": \"Adam\",\n    \"params\": {\n      \"lr\": 1.5e-5,\n      \"betas\": [0.9, 0.95],\n      \"eps\": 1.0e-8\n    }\n  },\n\n  \"min_lr\": 8.e-6, \n  \"zero_optimization\": {\n    \"stage\": 1,\n    \"allgather_partitions\": true,\n    \"allgather_bucket_size\": 500000000,\n    \"overlap_comm\": true,\n    \"reduce_scatter\": true,\n    \"reduce_bucket_size\": 500000000,\n    \"contiguous_gradients\": true\n  },\n  \"train_micro_batch_size_per_gpu\": 1,\n  \"gradient_accumulation_steps\": 64,\n  \"data-impl\": \"mmap\",\n  \"split\": \"995,4,1\",\n\n  \"checkpoint-activations\": true,\n  \"checkpoint-num-layers\": 1,\n  \"partition-activations\": false,\n  \"synchronize-each-layer\": true,\n\n  \"gradient_clipping\": 0.4, # from 1.0\n  \"weight-decay\": 0.1,\n  \"hidden-dropout\": 0,\n  \"attention-dropout\": 0,\n\n  # \"fp16\": {\n  #   \"fp16\": true,\n  #   \"enabled\": true,\n  #   \"loss_scale\": 0,\n  #   \"loss_scale_window\": 1000,\n  #   \"initial_scale_power\": 12,\n  #   \"hysteresis\": 2,\n  #   \"min_loss_scale\": 1\n  # },\n\n  \"precision\": \"bfloat16\",\n  \"bf16\": {\n    \"enabled\": true\n  },\n  \"fp32_allreduce\": true, # without a patch to torch, bf16 models have to do the allreduce in fp32\n  \"data_types\": { \"grad_accum_dtype\": \"fp32\" },\n\n  \"fp16\": {\n    \"enabled\": false,\n    \"type\": \"bfloat16\", # set bf16 as precision\n    \"loss_scale\": 0,\n    \"loss_scale_window\": 1000,\n    \"hysteresis\": 2,\n    \"min_loss_scale\": 1\n  },\n\n  \"train-iters\": 58831, # 77109892053/(4096*1*64*8*20/8/4)=58,831\n  \"lr-decay-iters\": 58831,\n\n  \"distributed-backend\": \"nccl\",\n  \"lr-decay-style\": \"cosine\",\n  \"warmup\": 0.05,  # from 0.01\n  \"checkpoint-factor\": 500,\n  \"eval-interval\": 10000000, # \u4e0d\u8fdb\u884ceval\n  \"eval-iters\": 100,\n\n  \"log_grad_info\": true,\n  \"log_param_info\": true,\n  \"log_param_norm\": true,\n\n  \"log-interval\": 1,\n  \"steps_per_print\": 1,\n  \"wall_clock_breakdown\": false, # ?\n\n  \"tokenizer_type\": \"HFLlamaTokenizer\",\n  \"tensorboard-dir\": \"/shared_space/agpt/experiments/0926/logs/tensorboard_65b\",\n  \"log-dir\": \"/shared_space/agpt/experiments/0926/logs/logs_70b/\",\n  \"checkpoint_validation_with_forward_pass\": false\n}\n"}, "load": "/shared_space/agpt/experiments/0808/checkpoints", "checkpoint_factor": 500, "load_module_only": true, "finetune": true, "batch_size": 1, "train_iters": 58831, "eval_interval": 10000000, "split": "995,4,1", "vocab_file": "/shared_space/agpt/models/llama2/hf/70B", "attention_dropout": 0, "hidden_dropout": 0, "weight_decay": 0.1, "checkpoint_activations": true, "synchronize_each_layer": true, "gas": 64, "clip_grad": 0.4, "dynamic_loss_scale": true, "pipe_parallel_size": 8, "model_parallel_size": 4, "world_size": 160, "is_pipe_parallel": true, "use_wandb": true, "wandb_group": "70b_r8ad9wta", "wandb_team": "academicgpt", "wandb_project": "llama2_70b_pretrain2", "log_dir": "/shared_space/agpt/experiments/0926/logs/logs_70b/", "tensorboard_dir": "/shared_space/agpt/experiments/0926/logs/tensorboard_65b", "log_interval": 1, "log_param_norm": true, "log_param_info": true, "log_grad_info": true, "text_gen_type": "unconditional", "local_rank": 0, "rank": 0, "user_script": "/platform_tech/jyren/pretrainpipeline/train.py", "save_iters": [500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000, 6500, 7000, 7500, 8000, 8500, 9000, 9500, 10000, 10500, 11000, 11500, 12000, 12500, 13000, 13500, 14000, 14500, 15000, 15500, 16000, 16500, 17000, 17500, 18000, 18500, 19000, 19500, 20000, 20500, 21000, 21500, 22000, 22500, 23000, 23500, 24000, 24500, 25000, 25500, 26000, 26500, 27000, 27500, 28000, 28500, 29000, 29500, 30000, 30500, 31000, 31500, 32000, 32500, 33000, 33500, 34000, 34500, 35000, 35500, 36000, 36500, 37000, 37500, 38000, 38500, 39000, 39500, 40000, 40500, 41000, 41500, 42000, 42500, 43000, 43500, 44000, 44500, 45000, 45500, 46000, 46500, 47000, 47500, 48000, 48500, 49000, 49500, 50000, 50500, 51000, 51500, 52000, 52500, 53000, 53500, 54000, 54500, 55000, 55500, 56000, 56500, 57000, 57500, 58000, 58500], "global_num_gpus": 160}